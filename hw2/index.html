<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Waste Visualization with Zoom</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { display: flex; justify-content: space-around; align-items: flex-start; margin: 20px; }
        svg { border: 1px solid #ccc; }
        .tooltip {
            position: absolute;
            background: white;
            padding: 8px;
            border: 1px solid #ccc;
            pointer-events: none;
            display: none;
            font-size: 14px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .legend { font-size: 12px; }
        h1 { text-align: center; margin-top: 20px; }
        p { text-align: center; max-width: 800px; margin: 10px auto; }
        #bar-chart { width: 400px; margin-left: 20px; }
        #bar-chart h2 { font-size: 18px; margin-bottom: 10px; }
        #bar-chart svg { margin-top: 10px; }
        .country { stroke: #000; stroke-width: 0.5; }
        .country.clicked { stroke-width: 2; } 
        .intro { max-width: 800px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .intro h2 { text-align: center; margin-bottom: 15px; }
        .intro p { text-align: left; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Global Food Waste by Country</h1>

    <div class="intro">
        <h2>About the Visualization</h2>
        <p>
            This visualization explores global food waste data, sourced from the United Nations Environment Programme (UNEP). 
            The dataset provides insights into food waste generated by households, retail, and food services across countries, 
            measured in kilograms per capita per year. Food waste is a critical global issue, contributing to environmental 
            degradation, resource depletion, and hunger. Understanding where and how food is wasted can help policymakers, 
            organizations, and individuals take action to reduce waste and promote sustainability.
        </p>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
        <label for="category">Select Waste Type:</label>
        <select id="category">
            <option value="combined">Total Waste</option>
            <option value="household">Household Waste</option>
            <option value="retail">Retail Waste</option>
            <option value="food_service">Food Service Waste</option>
        </select>
    </div>

    <!-- Visualization Container -->
    <div class="container">
        <div>
            <svg id="map" width="800" height="500"></svg>
            <div id="legend-container" style="text-align: center; margin-top: 10px;">
                <svg id="legend" width="300" height="50"></svg>
                <div style="font-size: 12px; margin-top: 5px;">kg/capita/year</div>
            </div>
        </div>
        <div id="bar-chart">
            <h2>Waste Breakdown</h2>
            <svg id="bar-svg" width="400" height="250"></svg>
        </div>
    </div>

    <!-- Tooltip for Hover Interactions -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        const width = 800, height = 500;
        const svg = d3.select("#map");
        const tooltip = d3.select("#tooltip");
        const projection = d3.geoNaturalEarth1().scale(150).translate([width / 2, height / 2]);
        const path = d3.geoPath().projection(projection);

        let data;
        let clickedCountry = null;

        // Add a clipPath to prevent the map from overflowing
        svg.append("defs").append("clipPath")
            .attr("id", "map-clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height);

        // Create a group for the map and apply the clipPath
        const mapGroup = svg.append("g")
            .attr("clip-path", "url(#map-clip)");

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([1, 8]) // Limit zoom level
            .on("zoom", zoomed);

        svg.call(zoom);

        function zoomed(event) {
            // Update the map group's transform based on the zoom event
            mapGroup.attr("transform", event.transform);
        }

        Promise.all([
            d3.json("countries-50m.json"),
            d3.csv("foodwaste.csv")
        ]).then(([world, csvData]) => {
            data = csvData;
            updateMap("combined", world);

            d3.select("#category").on("change", function() {
                updateMap(this.value, world);
            });
        });

        function updateMap(wasteType, world) {
            const countries = topojson.feature(world, world.objects.countries);
            const wasteColumn = {
                combined: "combined figures (kg/capita/year)",
                household: "Household estimate (kg/capita/year)",
                retail: "Retail estimate (kg/capita/year)",
                food_service: "Food service estimate (kg/capita/year)"
            }[wasteType];

            const foodWaste = new Map(data.map(d => [d.Country, +d[wasteColumn]]));

            const colorScale = d3.scaleQuantize()
                .domain(d3.extent([...foodWaste.values()]))
                .range(d3.schemeReds[7]);

            mapGroup.selectAll(".country").remove();

            mapGroup.selectAll(".country")
                .data(countries.features)
                .join("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", d => {
                    const waste = foodWaste.get(d.properties.name);
                    return waste ? colorScale(waste) : "#ffffff"; // White for no data
                })
                .attr("stroke", "#000") // Bold black outlines
                .attr("stroke-width", 0.5) // Adjust stroke width
                .on("mouseover", (event, d) => {
                    const waste = foodWaste.get(d.properties.name) || "No Data";
                    tooltip.style("display", "block").html(`<strong>${d.properties.name}</strong><br>Waste: ${waste} kg/capita/year`)
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", () => tooltip.style("display", "none"))
                .on("click", (event, d) => {
                    if (clickedCountry) {
                        clickedCountry.classed("clicked", false);
                    }
                    clickedCountry = d3.select(event.currentTarget).classed("clicked", true);
                    showBarChart(d.properties.name);
                });

            const legendSvg = d3.select("#legend").html("");
            const legendScale = d3.scaleLinear().domain(colorScale.domain()).range([0, 300]);
            const legendAxis = d3.axisBottom(legendScale).ticks(5);

            const gradient = legendSvg.append("defs").append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%").attr("y1", "0%")
                .attr("x2", "100%").attr("y2", "0%");

            colorScale.range().forEach((color, i, arr) => {
                gradient.append("stop")
                    .attr("offset", `${(i / (arr.length - 1)) * 100}%`)
                    .attr("stop-color", color);
            });

            legendSvg.append("rect")
                .attr("width", 300)
                .attr("height", 20)
                .style("fill", "url(#legend-gradient)");

            legendSvg.append("g")
                .attr("transform", "translate(0,20)")
                .call(legendAxis);
        }

        function showBarChart(country) {
            const countryData = data.find(d => d.Country === country);
            if (!countryData) return;

            d3.select("#bar-chart h2").text(`${country} - Waste Breakdown`);
            const categories = [
                { name: "Household", value: +countryData["Household estimate (kg/capita/year)"] },
                { name: "Retail", value: +countryData["Retail estimate (kg/capita/year)"] },
                { name: "Food Service", value: +countryData["Food service estimate (kg/capita/year)"] }
            ];

            const barWidth = 300, barHeight = 200;
            const x = d3.scaleBand().domain(categories.map(d => d.name)).range([0, barWidth]).padding(0.2);
            const y = d3.scaleLinear().domain([0, d3.max(categories, d => d.value)]).range([barHeight, 0]);

            const svgBar = d3.select("#bar-svg").html("")
                .attr("width", barWidth + 50)
                .attr("height", barHeight + 50)
                .append("g")
                .attr("transform", "translate(30,10)");

            svgBar.selectAll("rect")
                .data(categories)
                .join("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => barHeight - y(d.value))
                .attr("fill", "steelblue")
                .append("title").text(d => `${d.name}: ${d.value} kg/capita/year`);

            svgBar.append("g")
                .attr("transform", `translate(0,${barHeight})`)
                .call(d3.axisBottom(x));

            svgBar.append("g")
                .call(d3.axisLeft(y));
        }
    </script>
</body>
</html>