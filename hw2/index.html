<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Waste Visualization</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; justify-content: space-around; }
        svg { border: 1px solid #ccc; }
        .tooltip {
            position: absolute;
            background: white;
            padding: 8px;
            border: 1px solid #ccc;
            pointer-events: none;
            display: none;
        }
        .legend { font-size: 12px; }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Global Food Waste by Country</h1>

    <div style="width: 80%; margin: 0 auto; text-align: center;">
        <p>This visualization displays the amount of food waste generated by different countries. You can use the dropdown menu below to select a specific type of waste to view, such as household, retail, or food service waste. Hover over a country on the map to see detailed waste data. Click on a country to view a breakdown of its waste by category.</p>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
        <label for="category">Select Waste Type:</label>
        <select id="category">
            <option value="combined">Total Waste</option>
            <option value="household">Household Waste</option>
            <option value="retail">Retail Waste</option>
            <option value="food_service">Food Service Waste</option>
        </select>
    </div>

    <div class="container">
        <div>
            <svg id="map" width="800" height="500"></svg>
            <svg id="legend" width="300" height="50" style="margin-top:10px;"></svg>
        </div>
        <div id="bar-chart"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const width = 800, height = 500;
        const svg = d3.select("#map");
        const tooltip = d3.select("#tooltip");
        const projection = d3.geoNaturalEarth1().scale(150).translate([width/2, height/2]);
        const path = d3.geoPath().projection(projection);

        let data;

        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json"),
            d3.csv("foodwaste.csv")
        ]).then(([world, csvData]) => {
            data = csvData;
            updateMap("combined", world);

            d3.select("#category").on("change", function() {
                updateMap(this.value, world);
            });
        });

        function updateMap(wasteType, world) {
            const countries = topojson.feature(world, world.objects.countries);
            const wasteColumn = {
                combined: "combined figures (kg/capita/year)",
                household: "Household estimate (kg/capita/year)",
                retail: "Retail estimate (kg/capita/year)",
                food_service: "Food service estimate (kg/capita/year)"
            }[wasteType];

            const foodWaste = new Map(data.map(d => [d.Country, +d[wasteColumn]]));

            const colorScale = d3.scaleQuantize()
                .domain(d3.extent([...foodWaste.values()]))
                .range(d3.schemeReds[7]);

            svg.selectAll(".country").remove();

            svg.selectAll(".country")
                .data(countries.features)
                .join("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", d => colorScale(foodWaste.get(d.properties.name) || 0))
                .on("mouseover", (event, d) => {
                    const waste = foodWaste.get(d.properties.name) || "No Data";
                    tooltip.style("display", "block").html(`<strong>${d.properties.name}</strong><br>Waste: ${waste} kg`)
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", () => tooltip.style("display", "none"))
                .on("click", (event, d) => showBarChart(d.properties.name));

            const legendSvg = d3.select("#legend").html("");
            const legendScale = d3.scaleLinear().domain(colorScale.domain()).range([0, 300]);
            const legendAxis = d3.axisBottom(legendScale).ticks(5);

            const gradient = legendSvg.append("defs").append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%").attr("y1", "0%")
                .attr("x2", "100%").attr("y2", "0%");

            colorScale.range().forEach((color, i, arr) => {
                gradient.append("stop")
                    .attr("offset", `${(i/(arr.length-1))*100}%`)
                    .attr("stop-color", color);
            });

            legendSvg.append("rect")
                .attr("width", 300)
                .attr("height", 20)
                .style("fill", "url(#legend-gradient)");

            legendSvg.append("g").attr("transform", "translate(0,20)").call(legendAxis);
        }

        function showBarChart(country) {
            const countryData = data.find(d => d.Country === country);
            if (!countryData) return;
            
            d3.select("#bar-chart").html(`<h2>${country} - Waste Breakdown</h2>`);
            const categories = [
                { name: "Household", value: +countryData["Household estimate (kg/capita/year)"] },
                { name: "Retail", value: +countryData["Retail estimate (kg/capita/year)"] },
                { name: "Food Service", value: +countryData["Food service estimate (kg/capita/year)"] }
            ];
            
            const barWidth = 300, barHeight = 200;
            const x = d3.scaleBand().domain(categories.map(d => d.name)).range([0, barWidth]).padding(0.2);
            const y = d3.scaleLinear().domain([0, d3.max(categories, d => d.value)]).range([barHeight, 0]);
            
            const svgBar = d3.select("#bar-chart").append("svg").attr("width", barWidth + 50).attr("height", barHeight + 50)
                .append("g").attr("transform", "translate(30,10)");
            
            svgBar.selectAll("rect")
                .data(categories)
                .join("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => barHeight - y(d.value))
                .attr("fill", "steelblue")
                .append("title").text(d => `${d.name}: ${d.value} kg`);
            
            svgBar.append("g").attr("transform", `translate(0,${barHeight})`).call(d3.axisBottom(x));
            svgBar.append("g").call(d3.axisLeft(y));
        }
    </script>
</body>
</html>
